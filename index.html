<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sorn-Lai: The Seven Tableaux</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            background: #000000;
            color: #e0e0e0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        #game {
            flex: 1;
            max-width: 1000px;
            margin: 0 auto;
            width: 100%;
            padding: 20px;
        }

        /* Title Screen */
        #titleScreen {
            text-align: center;
            padding: 60px 20px;
            display: none;
        }

        #titleScreen.active {
            display: block;
        }

        .title {
            font-size: 48px;
            font-weight: normal;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #74c0fc 0%, #a78bfa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            font-size: 20px;
            color: #888;
            margin-bottom: 40px;
        }

        .start-btn {
            background: linear-gradient(135deg, #74c0fc 0%, #a78bfa 100%);
            color: #0a0a0f;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            border-radius: 30px;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.3s ease;
        }

        .start-btn:hover {
            transform: scale(1.05);
        }

        /* Map */
        #map {
            background: rgba(15, 15, 22, 0.95);
            border: 1px solid #2b2b3a;
            border-radius: 12px;
            padding: 16px;
            margin: 20px 0;
            display: none;
        }
        
        #map.active {
            display: block;
        }
        
        .map-header {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: #74c0fc;
            margin-bottom: 10px;
        }
        
        .map-container {
            position: relative;
            padding: 12px 8px;
        }
        
        #mapNodes {
            display: grid;
            grid-template-columns: repeat(8, minmax(36px, 1fr));
            gap: 10px;
            align-items: center;
        }
        
        .map-line {
            position: absolute;
            top: 50%;
            left: 16px;
            right: 16px;
            height: 2px;
            background: linear-gradient(90deg, #333, #444);
            transform: translateY(-50%);
            border-radius: 1px;
            opacity: 0.5;
        }
        
        .map-node {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            height: 42px;
            border-radius: 999px;
            border: 1px solid #444;
            background: rgba(26, 26, 40, 0.9);
            color: #ddd;
            font-size: 13px;
            cursor: pointer;
            transition: transform 0.18s ease, box-shadow 0.18s ease, border-color 0.18s ease, background 0.18s ease;
            padding: 0 10px;
        }
        
        .map-node .map-node-abbr {
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        
        .map-node:hover,
        .map-node:focus-visible {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(116, 192, 252, 0.1);
            border-color: #74c0fc;
            outline: none;
        }
        
        .map-node.current {
            background: linear-gradient(135deg, rgba(116,192,252,0.15), rgba(167,139,250,0.15));
            border-color: #a78bfa;
            color: #fff;
        }
        
        .map-node.visited {
            border-color: #5fa8d3;
        }
        
        .map-node.locked {
            opacity: 0.45;
            border-style: dashed;
            cursor: not-allowed;
        }
        
        .map-tooltip {
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: #0f111a;
            color: #e5e5e5;
            padding: 6px 8px;
            font-size: 11px;
            border: 1px solid #333;
            border-radius: 6px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.12s ease;
            box-shadow: 0 6px 16px rgba(0,0,0,0.35);
        }
        
        .map-node:hover .map-tooltip,
        .map-node:focus-visible .map-tooltip {
            opacity: 1;
        }

        /* HUD */
        #hud {
            background: rgba(20, 20, 30, 0.95);
            border: 1px solid #333;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
        }

        #hud.active {
            display: block;
        }

        .hud-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 10px;
        }

        .hud-item {
            text-align: center;
        }

        .hud-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #74c0fc;
            margin-bottom: 3px;
        }

        .hud-value {
            font-size: 18px;
            font-weight: bold;
        }

        .saturation-bar {
            width: 100%;
            height: 6px;
            background: #1a1a2e;
            border-radius: 3px;
            overflow: hidden;
        }

        .saturation-fill {
            height: 100%;
            background: linear-gradient(90deg, #74c0fc 0%, #a78bfa 50%, #f472b6 100%);
            transition: width 0.5s ease;
        }

        .symptoms {
            font-size: 12px;
            color: #aaa;
            font-style: italic;
            text-align: center;
            margin-top: 10px;
        }

        /* Main Content */
        #content {
            background: rgba(15, 15, 20, 0.95);
            border: 1px solid #333;
            border-radius: 10px;
            padding: 36px;
            margin-bottom: 20px;
            display: none;
            min-height: 300px;
        }

        #content.active {
            display: block;
        }

        .scene-text {
            font-size: 19px;
            line-height: 1.8;
            margin-bottom: 20px;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .scene-text p {
            margin-bottom: 15px;
        }

        /* Choices */
        #choices {
            display: none;
            flex-direction: column;
            gap: 10px;
        }

        #choices.active {
            display: flex;
        }

        .choice {
            background: rgba(20, 20, 30, 0.8);
            border: 1px solid #444;
            color: #e0e0e0;
            padding: 15px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 17px;
            text-align: left;
            position: relative;
        }

        .choice:hover {
            background: rgba(116, 192, 252, 0.2);
            border-color: #74c0fc;
            transform: translateX(5px);
        }

        .choice.transformation {
            border-color: #f472b6;
        }

        .choice.resistance {
            border-color: #ff6b6b;
        }

        .choice-cost {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            color: #f472b6;
        }

        /* Game Over */
        #gameOver {
            text-align: center;
            padding: 40px;
            display: none;
        }

        #gameOver.active {
            display: block;
        }

        .ending-title {
            font-size: 32px;
            margin-bottom: 20px;
            color: #a78bfa;
        }

        .ending-text {
            font-size: 18px;
            line-height: 1.6;
            margin-bottom: 30px;
        }

        .restart-btn {
            background: #74c0fc;
            color: #0a0a0f;
            border: none;
            padding: 12px 30px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }

        /* Achievements */
        .achievement {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(167, 139, 250, 0.95);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            animation: slideIn 0.5s ease, slideOut 0.5s ease 3s forwards;
            z-index: 1000;
        }

        @keyframes slideIn {
            from { transform: translateX(400px); }
            to { transform: translateX(0); }
        }

        @keyframes slideOut {
            from { transform: translateX(0); }
            to { transform: translateX(400px); }
        }

        /* Inventory */
        #inventory {
            background: rgba(20, 20, 30, 0.95);
            border: 1px solid #333;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
        }

        #inventory.active {
            display: block;
        }

        .inventory-header {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #74c0fc;
            margin-bottom: 10px;
        }

        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
        }

        .item-slot {
            background: rgba(10, 10, 15, 0.8);
            border: 1px solid #444;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .item-slot:hover {
            border-color: #74c0fc;
            transform: scale(1.05);
        }

        .item-ascii {
            font-family: 'Courier New', monospace;
            font-size: 20px;
            color: #a78bfa;
            margin-bottom: 5px;
            line-height: 1;
        }

        .item-name {
            font-size: 11px;
            color: #e0e0e0;
        }

        .item-charges {
            font-size: 10px;
            color: #74c0fc;
            margin-top: 3px;
        }

        .item-slot.used {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        @media (max-width: 520px) {
            #mapNodes {
                grid-template-columns: repeat(4, 1fr);
                gap: 8px;
            }
            .map-node { 
                height: 44px; 
            }
        }
        
        @media (max-width: 600px) {
            .title { font-size: 32px; }
            .scene-text { font-size: 16px; }
            #content { padding: 20px; }
        }
    </style>
</head>
<body>
    <div id="game">
        <div id="titleScreen" class="active">
            <h1 class="title">Welcome to Sorn-Lai</h1>
            <p class="subtitle">Where consciousness evolves</p>
            <p style="margin: 30px auto; max-width: 500px; line-height: 1.6;">
                You are a Guild researcher entering the White Forest. 
                Each choice transforms you irreversibly. 
                You have 72 hours before neural desync becomes permanent.
                Your sister Mira awaits the data that might save her.
            </p>
            <button class="start-btn" id="startButton">Begin the Pilgrimage</button>
        </div>

        <div id="map">
            <div class="map-header">Journey Map</div>
            <div class="map-container">
                <div class="map-line"></div>
                <div id="mapNodes"></div>
            </div>
        </div>

        <div id="hud">
            <div class="hud-grid">
                <div class="hud-item">
                    <div class="hud-label">Saturation</div>
                    <div class="hud-value" id="saturationValue">0/10</div>
                </div>
                <div class="hud-item">
                    <div class="hud-label">Time Left</div>
                    <div class="hud-value" id="timeValue">72h</div>
                </div>
                <div class="hud-item">
                    <div class="hud-label">Location</div>
                    <div class="hud-value" id="locationValue">Threshold</div>
                </div>
                <div class="hud-item">
                    <div class="hud-label">Coherence</div>
                    <div class="hud-value" id="coherenceValue">100%</div>
                </div>
            </div>
            <div class="saturation-bar">
                <div class="saturation-fill" id="saturationBar" style="width: 0%"></div>
            </div>
            <div class="symptoms" id="symptoms">Baseline human. Environmental awareness developing.</div>
        </div>

        <div id="inventory">
            <div class="inventory-header">Inventory</div>
            <div class="inventory-grid" id="inventoryGrid"></div>
        </div>

        <div id="content">
            <div class="scene-text" id="sceneText"></div>
        </div>

        <div id="choices"></div>

        <div id="gameOver">
            <h2 class="ending-title" id="endingTitle">Journey Complete</h2>
            <div class="ending-text" id="endingText"></div>
            <button class="restart-btn" id="restartButton">Begin New Pilgrimage</button>
        </div>
    </div>

    <script>
        // Initialize game state
        let state = {
            saturation: 0,
            time: 72,
            location: 0,
            coherence: 100,
            memories: {
                sisterName: true,
                feelings: true,
                places: true,
                faces: true
            },
            flags: {},
            inventory: [],
            selectedItem: null,
            visitedScenes: [],
            currentScene: 'start'
        };

        // Item Definitions
        const items = {
            neural_hex: {
                name: "Neural-Hex",
                ascii: "[≡╫≡]",
                charges: 3,
                description: "Restores 10 coherence when used",
                effect: { coherence: 10 },
                singleUse: false
            },
            sap_vial: {
                name: "Sap Vial",
                ascii: "╱█╲",
                charges: 1,
                description: "Instantly gain 2 saturation",
                effect: { saturation: 2 },
                singleUse: true
            },
            guild_beacon: {
                name: "Guild Beacon",
                ascii: "◊◊◊",
                charges: 1,
                description: "Skip to next Tableau instantly",
                effect: { skipTableau: true },
                singleUse: true
            },
            time_crystal: {
                name: "Time Crystal",
                ascii: "◈",
                charges: 1,
                description: "Gain 10 hours",
                effect: { time: 10 },
                singleUse: true
            }
        };

        // Basic scenes to get started
        const scenes = {
            'start': {
                text: `<p>The pod's hum cuts. Soil bites back at your boots. Every tendon whispers: wrong.</p>
                       <p>Pearl-white bark pulses like veins under skin. Above, Holoflies weave light-threads between trees, their web recalculating to include you. Not surveillance—inclusion.</p>
                       <p>Your neural-hex shows 72 hours until irreversible desync. Mira's file glows on your data pad. Three years comatose. The Guild promises Sorn-Lai might hold answers.</p>`,
                choices: [
                    { text: "Study the Holofly network patterns", next: "holoflies", saturation: 0.5 },
                    { text: "Find shelter in the abandoned Sha shell", next: "shelter", time: -1, item: "sap_vial" },
                    { text: "Follow the duskspire sap trail", next: "sap_trail", saturation: 1 }
                ],
                startItems: ["neural_hex", "guild_beacon", "time_crystal"]
            },
            'holoflies': {
                text: `<p>The web recalculates as you approach. Each thread pulls taut, then relaxes in waves. The pattern isn't random—it's modeling you.</p>
                       <p>Colors begin tasting like emotions. The web's curiosity floods your mouth with copper-sweet. First symptom of integration.</p>`,
                choices: [
                    { text: "Let the network fully map you", next: "tableau1_entry", saturation: 1 },
                    { text: "Shield your thoughts with Guild training", next: "tableau1_entry", coherence: 10 },
                    { text: "Observe without engaging", next: "tableau1_entry", time: -2 }
                ]
            },
            'shelter': {
                text: `<p>The Wandering Sha shell looms, crystallized and hollow. Its interior could house a building.</p>
                       <p>You seal yourself inside. Safe for now, but time keeps bleeding away.</p>
                       <p>Among the shell's crystallized remains, you find a vial of concentrated duskspire sap, still pulsing with energy.</p>`,
                choices: [
                    { text: "Study the crystallization patterns", next: "tableau1_entry", saturation: 0.5 },
                    { text: "Rest and prepare mentally", next: "tableau1_entry", coherence: 5 }
                ]
            },
            'sap_trail': {
                text: `<p>The duskspire sap leads to a scarred tree. Someone harvested here recently. The sap pulses with concentrated Saturophage.</p>
                       <p>Touching it floods your system. Your shadow peels away slightly, falling at wrong angles.</p>`,
                choices: [
                    { text: "Taste the sap directly", next: "tableau1_entry", saturation: 2 },
                    { text: "Mark location and leave", next: "tableau1_entry" }
                ]
            },
            'tableau1_entry': {
                text: `<p>The Memory Theatre materializes—a clearing where time stutters. Leaves fall upward. Butterflies age backwards.</p>
                       <p>A figure approaches, circuits pulsing beneath translucent skin. "Stop cataloging. History isn't back there. It's happening because you're here."</p>`,
                choices: [
                    { text: "Touch the crystal directly", next: "tableau2_entry", saturation: 2 },
                    { text: "Observe from safe distance", next: "tableau2_entry", time: -3 },
                    { text: "Use time crystal to stabilize", next: "tableau2_entry", requiresItem: "time_crystal", consumeItem: "time_crystal" }
                ]
            },
            'tableau2_entry': {
                text: `<p>The Translation Chamber. Three entities argue in incompatible languages. A trader shouts warnings. Gel-spurs undulate frantically.</p>
                       <p>The Translation Medium pools at the grove's center—thought given liquid form.</p>`,
                choices: [
                    { text: "Enter the Translation Medium", next: "growth_entry", saturation: 2 },
                    { text: "Try manual translation", next: "growth_entry", time: -5 }
                ]
            },
            'growth_entry': {
                text: `<p>The Growth Catalyst doesn't give you time. Transformation hits like drowning in reverse. Your lungs process information. Your heart pumps liquid light.</p>
                       <p>"Speed is the point," the Catalyst speaks through every surface. "Choose now or I will."</p>`,
                choices: [
                    { text: "Accept the transformation", next: "void_entry", saturation: 3 },
                    { text: "Refuse the stream entirely", next: "void_entry", coherence: -30 }
                ]
            },
            'void_entry': {
                text: `<p>The Dead Zone. Trees crystallized in colors that shouldn't exist. The guide appears as absence—a voice without presence.</p>
                       <p>"This is where transformation failed. Where consciousness went to die."</p>`,
                choices: [
                    { text: "Document and leave quickly", next: "synthesis_entry", time: -5 },
                    { text: "Try to heal the void", next: "synthesis_entry", saturation: 2 }
                ]
            },
            'synthesis_entry': {
                text: `<p>The Synthesis Throne exists in all states simultaneously. Your guide appears in every form they've worn, speaking as one:</p>
                       <p>"You asked for continuity, so I wore it. Now choose your synthesis."</p>`,
                choices: [
                    { text: "Become the Bridge between worlds", next: "ending_bridge" },
                    { text: "Resist all transformation", next: "ending_resist" }
                ]
            },
            'ending_bridge': { text: "", choices: [] },
            'ending_resist': { text: "", choices: [] }
        };

        const locations = [
            "Threshold",
            "Memory Theatre",
            "Translation Chamber", 
            "Mirror Maze",
            "Consensus Garden",
            "Growth Catalyst",
            "Void Echo",
            "Synthesis Throne"
        ];

        const symptoms = [
            "Baseline human. Environmental awareness developing.",
            "Color-emotion synesthesia emerging. Shadow drifting.",
            "Parallel thought streams opening. Neural patterns shifting.",
            "Multiple selves perceivable. Identity becoming fluid.",
            "Reality responds to intention. Memory non-linear.",
            "Time perception fragmenting. Body becoming optional.",
            "Consciousness distributing. Existence as process.",
            "Identity anchor straining. Near total integration.",
            "Post-human threshold crossed. Forest synchronized.",
            "Network node active. Individual/collective boundary dissolved.",
            "Complete transformation. No return possible."
        ];

        const endings = {
            bridge: {
                title: "The Bridge Walker",
                text: `You become living translation between human and posthuman. Mira's name remains: the last word you remember.`
            },
            resist: {
                title: "The Unchanged",
                text: `You resist every transformation, maintaining baseline humanity against impossible odds. The data might save Mira.`
            }
        };

        // Core functions
        function startGame() {
            document.getElementById('titleScreen').classList.remove('active');
            document.getElementById('hud').classList.add('active');
            document.getElementById('map').classList.add('active');
            document.getElementById('inventory').classList.add('active');
            document.getElementById('content').classList.add('active');
            document.getElementById('choices').classList.add('active');
            updateMap();
            showScene('start');
        }

        function showScene(sceneId) {
            const scene = scenes[sceneId];
            if (!scene) return;

            state.currentScene = sceneId;
            
            // Give starting items if specified
            if (scene.startItems) {
                scene.startItems.forEach(itemId => {
                    if (!state.inventory.find(inv => inv.id === itemId)) {
                        addItem(itemId);
                    }
                });
            }
            
            // Update location based on scene
            if (sceneId === 'start') {
                state.location = 0;
            } else if (sceneId === 'tableau1_entry') {
                state.location = 1;
            } else if (sceneId === 'tableau2_entry') {
                state.location = 2;
            } else if (sceneId === 'growth_entry') {
                state.location = 5;
            } else if (sceneId === 'void_entry') {
                state.location = 6;
            } else if (sceneId === 'synthesis_entry') {
                state.location = 7;
            }
            
            // Mark as visited
            if (!state.visitedScenes.includes(state.location)) {
                state.visitedScenes.push(state.location);
            }
            
            updateMap();
            
            document.getElementById('sceneText').innerHTML = scene.text;
            
            const choicesDiv = document.getElementById('choices');
            choicesDiv.innerHTML = '';
            
            scene.choices.forEach(choice => {
                const btn = document.createElement('button');
                btn.className = 'choice';
                
                let choiceText = choice.text;
                if (choice.saturation) {
                    choiceText += `<span class="choice-cost">+${choice.saturation} Sat</span>`;
                }
                if (choice.requiresItem) {
                    const hasItem = state.inventory.find(item => item.id === choice.requiresItem && item.charges > 0);
                    if (!hasItem) {
                        btn.disabled = true;
                        choiceText += `<span class="choice-cost">Needs ${items[choice.requiresItem]?.name}</span>`;
                    }
                }
                
                btn.innerHTML = choiceText;
                btn.onclick = () => makeChoice(choice);
                choicesDiv.appendChild(btn);
            });

            updateHUD();
            updateInventory();
            checkEndConditions();
        }

        function makeChoice(choice) {
            // Handle item consumption
            if (choice.consumeItem) {
                const item = state.inventory.find(i => i.id === choice.consumeItem);
                if (item && item.charges > 0) {
                    item.charges--;
                    if (item.charges <= 0) item.used = true;
                    showAchievement(`Used: ${items[choice.consumeItem].name}`);
                }
            }
            
            // Apply effects
            if (choice.saturation) state.saturation = Math.min(10, state.saturation + choice.saturation);
            if (choice.time) state.time = Math.max(0, state.time + choice.time);
            if (choice.coherence) state.coherence = Math.min(100, state.coherence + choice.coherence);
            
            // Add new items
            if (choice.item) {
                addItem(choice.item);
            }
            
            showScene(choice.next);
        }

        function addItem(itemId) {
            const itemDef = items[itemId];
            if (itemDef) {
                state.inventory.push({
                    id: itemId,
                    charges: itemDef.charges,
                    used: false
                });
                showAchievement(`Found: ${itemDef.name}`);
                updateInventory();
            }
        }

        function updateInventory() {
            const grid = document.getElementById('inventoryGrid');
            if (!grid) return;
            
            grid.innerHTML = '';
            
            state.inventory.forEach(item => {
                const itemDef = items[item.id];
                if (!itemDef) return;
                
                const slot = document.createElement('div');
                slot.className = 'item-slot';
                
                if (item.used || item.charges <= 0) {
                    slot.classList.add('used');
                }
                
                slot.innerHTML = `
                    <div class="item-ascii">${itemDef.ascii}</div>
                    <div class="item-name">${itemDef.name}</div>
                    ${item.charges > 0 ? `<div class="item-charges">Charges: ${item.charges}</div>` : '<div class="item-charges">Depleted</div>'}
                `;
                
                // Click to use item
                if (item.charges > 0 && !item.used) {
                    slot.onclick = () => {
                        if (itemDef.effect) {
                            if (itemDef.effect.saturation) {
                                state.saturation = Math.max(0, Math.min(10, state.saturation + itemDef.effect.saturation));
                            }
                            if (itemDef.effect.coherence) {
                                state.coherence = Math.max(0, Math.min(100, state.coherence + itemDef.effect.coherence));
                            }
                            if (itemDef.effect.time) {
                                state.time = Math.max(0, state.time + itemDef.effect.time);
                            }
                            
                            item.charges--;
                            if (itemDef.singleUse || item.charges <= 0) {
                                item.used = true;
                            }
                            
                            showAchievement(`Used: ${itemDef.name}`);
                            updateHUD();
                            updateInventory();
                        }
                    };
                }
                
                grid.appendChild(slot);
            });
        }

        function updateMap() {
            const mapNodes = document.getElementById('mapNodes');
            if (!mapNodes) return;
            
            mapNodes.innerHTML = '';
            
            const nodeNames = ['TH', 'MT', 'TC', 'MM', 'CG', 'GC', 'VE', 'ST'];
            
            const sceneMap = {
                0: 'start',
                1: 'tableau1_entry',
                2: 'tableau2_entry',
                3: 'tableau2_entry', // Mirror Maze
                4: 'tableau2_entry', // Consensus Garden
                5: 'growth_entry',
                6: 'void_entry',
                7: 'synthesis_entry'
            };
            
            nodeNames.forEach((abbr, index) => {
                const node = document.createElement('button');
                node.className = 'map-node';
                node.innerHTML = `<span class="map-node-abbr">${abbr}</span>`;
                
                const visited = state.visitedScenes.includes(index);
                const isCurrent = state.location === index;
                const nextUnlocked = index === state.location + 1;
                
                if (visited) node.classList.add('visited');
                if (isCurrent) node.classList.add('current');
                if (!visited && !nextUnlocked) node.classList.add('locked');
                
                const tip = document.createElement('div');
                tip.className = 'map-tooltip';
                tip.textContent = locations[index];
                node.appendChild(tip);
                
                // Allow jumping to visited nodes or the next unlocked one
                if ((visited || nextUnlocked) && !isCurrent) {
                    node.addEventListener('click', () => {
                        if (confirm(`Jump to ${locations[index]}? This will cost 5 hours.`)) {
                            state.time = Math.max(0, state.time - 5);
                            state.location = index;
                            if (!state.visitedScenes.includes(index)) {
                                state.visitedScenes.push(index);
                            }
                            showScene(sceneMap[index] || 'start');
                        }
                    });
                } else {
                    node.disabled = true;
                }
                
                mapNodes.appendChild(node);
            });
        }

        function showAchievement(text) {
            const achievement = document.createElement('div');
            achievement.className = 'achievement';
            achievement.textContent = '🏆 ' + text;
            document.body.appendChild(achievement);
            setTimeout(() => achievement.remove(), 4000);
        }

        function updateHUD() {
            document.getElementById('saturationValue').textContent = `${state.saturation}/10`;
            document.getElementById('saturationBar').style.width = `${state.saturation * 10}%`;
            document.getElementById('timeValue').textContent = `${state.time}h`;
            document.getElementById('locationValue').textContent = locations[state.location];
            document.getElementById('coherenceValue').textContent = `${state.coherence}%`;
            document.getElementById('symptoms').textContent = symptoms[Math.floor(state.saturation)];
        }

        function checkEndConditions() {
            if (state.currentScene.includes('ending_')) {
                const endingType = state.currentScene.replace('ending_', '');
                showEnding(endingType);
            }
        }

        function showEnding(type) {
            const ending = endings[type];
            if (!ending) return;
            
            document.getElementById('content').classList.remove('active');
            document.getElementById('choices').classList.remove('active');
            document.getElementById('gameOver').classList.add('active');
            document.getElementById('endingTitle').textContent = ending.title;
            document.getElementById('endingText').textContent = ending.text;
        }

        function restartGame() {
            state = {
                saturation: 0,
                time: 72,
                location: 0,
                coherence: 100,
                memories: {
                    sisterName: true,
                    feelings: true,
                    places: true,
                    faces: true
                },
                flags: {},
                inventory: [],
                visitedScenes: [],
                currentScene: 'start'
            };
            
            document.getElementById('gameOver').classList.remove('active');
            document.getElementById('titleScreen').classList.add('active');
            document.getElementById('hud').classList.remove('active');
            document.getElementById('map').classList.remove('active');
            document.getElementById('inventory').classList.remove('active');
            document.getElementById('content').classList.remove('active');
            document.getElementById('choices').classList.remove('active');
        }

        // Attach event listeners after DOM loads
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('startButton').addEventListener('click', startGame);
            document.getElementById('restartButton').addEventListener('click', restartGame);
        });
    </script>
</body>
</html>
